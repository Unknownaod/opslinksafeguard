<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SafeGuard Panel ‚Äì Server Modules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #050711;
      --bg-elevated: #0b0f1e;
      --bg-card: #101524;
      --bg-card-soft: #141a2b;
      --accent: #ff7a1a;
      --accent-soft: rgba(255, 122, 26, 0.18);
      --accent-strong: #ff9b3d;
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --text-muted: #6b7280;
      --border-subtle: rgba(148, 163, 184, 0.18);
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.65);
      --radius-lg: 18px;
      --radius-xl: 26px;
      --transition-fast: 150ms ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top left, #111827 0, #020617 50%);
      min-height: 100vh;
    }

    /* Top bar */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      backdrop-filter: blur(18px);
      background: linear-gradient(
        to right,
        rgba(15, 23, 42, 0.94),
        rgba(15, 23, 42, 0.8),
        rgba(15, 23, 42, 0.7)
      );
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0%, #ffb26b 0, #ff7a1a 40%, #111827 100%);
      box-shadow: 0 0 18px rgba(255, 122, 26, 0.65);
      font-size: 22px;
    }

    .header-title {
      display: flex;
      flex-direction: column;
    }

    .header-title span:first-child {
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .header-title span:last-child {
      font-size: 12px;
      color: var(--text-soft);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: var(--text-soft);
    }

    .chip strong {
      color: var(--accent-strong);
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: transparent;
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast), color var(--transition-fast);
    }

    .btn:hover {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(226, 232, 240, 0.75);
      color: #e5e7eb;
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    .btn-primary {
      background: linear-gradient(135deg, #ff7a1a, #ff9b3d);
      border-color: transparent;
      color: #020617;
      font-weight: 500;
      box-shadow: 0 8px 30px rgba(248, 133, 31, 0.55);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #ffa94d, #ff7a1a);
      transform: translateY(-1px) translateX(0);
    }

    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 12px;
      color: var(--text-soft);
    }

    .user-pill img {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      object-fit: cover;
    }

    /* Main layout */
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 48px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-header h1 {
      font-size: 30px;
      margin: 0 0 6px;
      letter-spacing: 0.01em;
    }

    .page-header p {
      margin: 0;
      font-size: 14px;
      color: var(--text-soft);
    }

    .module-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }

    .module-card {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 60%);
      border-radius: var(--radius-lg);
      padding: 16px 16px 14px;
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .module-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, var(--accent-soft), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
    }

    .module-card-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .module-chip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-soft);
    }

    .module-name {
      font-weight: 600;
      font-size: 16px;
    }

    .module-desc {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.4;
      min-height: 40px;
    }

    .module-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      gap: 8px;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.75);
    }

    .badge-on {
      border-color: rgba(34, 197, 94, 0.55);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.16);
    }

    .btn-ghost {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
      transform: translateY(-1px);
    }

    /* Toggle */
    .toggle {
      position: relative;
      width: 40px;
      height: 20px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: rgba(15, 23, 42, 0.9);
      transition: 0.2s;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px; /* tiny tweak so it's visually centered */
      background-color: #e5e7eb;
      transition: 0.2s;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }

    input:checked + .slider {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      border-color: transparent;
    }

    input:checked + .slider:before {
      transform: translateX(18px);
      background-color: #020617;
    }

    /* Status bar */
    .status-bar {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(16px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: min(820px, 100% - 32px);
      max-height: 90vh;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 55%);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.85);
      padding: 20px 22px 18px;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .modal-header span {
      font-size: 12px;
      color: var(--text-soft);
    }

    .modal-body {
      padding-top: 6px;
      padding-bottom: 8px;
      overflow: auto;
      border-top: 1px solid rgba(148, 163, 184, 0.3);
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      margin-top: 8px;
      margin-bottom: 10px;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    .modal-section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .field-group {
      margin-bottom: 10px;
    }

    .field-label {
      font-size: 13px;
      margin-bottom: 3px;
      color: #e5e7eb;
    }

    .field-description {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 7px 9px;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.95);
      color: #f9fafb;
      outline: none;
      resize: vertical;
      min-height: 34px;
    }

    textarea {
      min-height: 70px;
    }

    input:focus,
    textarea:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(248, 163, 54, 0.7);
    }

    .modal-aside {
      font-size: 12px;
      color: var(--text-soft);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .save-status {
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .save-status span.icon {
      font-size: 14px;
    }

    .btn-secondary {
      border-radius: 999px;
      padding: 7px 12px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-fast), border-color var(--transition-fast),
        transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      border-color: rgba(248, 163, 54, 0.9);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.7);
      transform: translateY(-1px);
    }

    .btn-danger {
      border-radius: 999px;
      padding: 7px 12px;
      border: 1px solid rgba(248, 113, 113, 0.9);
      background: rgba(127, 29, 29, 0.5);
      color: #fecaca;
      font-size: 13px;
      cursor: pointer;
    }

    @media (max-width: 820px) {
      .modal-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        padding-inline: 16px;
      }
      .page {
        padding-inline: 16px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo-circle">üõ°Ô∏è</div>
      <div class="header-title">
        <span>SafeGuard Panel</span>
        <span id="guildLabel">Loading guild‚Ä¶</span>
      </div>
    </div>

    <div class="header-actions">
      <button class="btn" id="backBtn">‚Üê Servers</button>
      <div id="userPill" class="user-pill">
        <img id="userAvatar" src="https://cdn.discordapp.com/embed/avatars/0.png" alt="User" />
        <span id="userName">Not signed in</span>
      </div>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="page">
    <section class="page-header">
      <h1>Server Modules</h1>
      <p>
        Enable and configure SafeGuard‚Äôs systems for this server. Changes are saved
        live to MongoDB and mirrored by the bot.
      </p>
      <div class="status-bar">
        <div class="status-dot"></div>
        <span id="statusText">Connecting to Safeguard Panel API‚Ä¶</span>
      </div>
    </section>

    <section id="modulesSection">
      <div id="modulesGrid" class="module-grid"></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="moduleModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Module</h2>
          <span id="modalSubtitle">Edit configuration for this module.</span>
        </div>
        <button class="btn-secondary" id="closeModalBtn" type="button">‚úï Close</button>
      </div>

      <div class="modal-body">
        <form id="moduleForm">
          <div class="modal-grid">
            <div>
              <div class="modal-section-title">Configuration</div>
              <div id="modalFields"></div>
            </div>
            <aside class="modal-aside">
              <div class="modal-section-title">Hints</div>
              <div id="modalHints">
                Use placeholders like <code>{mention}</code>, <code>{user}</code>, <code>{server}</code>,
                <code>{membercount}</code> in messages. They will be replaced by live data.
              </div>
            </aside>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <div class="save-status" id="saveStatus">
          <span class="icon">üíæ</span>
          <span>Waiting for changes‚Ä¶</span>
        </div>
        <div>
          <button class="btn-secondary" id="resetFormBtn" type="button">Reset</button>
          <button class="btn-primary" id="saveFormBtn" type="button">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= UTIL / GLOBALS =========
    const pathParts = window.location.pathname.split("/").filter(Boolean);
    const guildId = pathParts[pathParts.length - 1];

    const token =
      localStorage.getItem("safeguard_token") ||
      localStorage.getItem("sg_token") ||
      localStorage.getItem("token");

    if (!token) {
      // Not logged in at all
      window.location.href = "/auth/discord";
    }

    const authHeader = { Authorization: "Bearer " + token };

    const modulesGrid = document.getElementById("modulesGrid");
    const guildLabel = document.getElementById("guildLabel");
    const userNameEl = document.getElementById("userName");
    const userAvatarEl = document.getElementById("userAvatar");
    const statusText = document.getElementById("statusText");

    const modalBackdrop = document.getElementById("moduleModalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubtitle = document.getElementById("modalSubtitle");
    const modalFields = document.getElementById("modalFields");
    const saveStatus = document.getElementById("saveStatus");
    const moduleForm = document.getElementById("moduleForm");

    let currentModule = null;
    let currentModules = [];

    // Module-specific field definitions
    const MODULE_DEFINITIONS = {
      tickets: {
        subtitle: "Ticket panels, claims, transcripts and logging.",
        hints:
          "Panels are created with /ticket panel create inside Discord. Here you can toggle the system and adjust default behaviour for your bot if you store extra options in Module.settings.",
        fields: [
          {
            key: "defaultPanelId",
            label: "Default Panel ID",
            type: "text",
            description: "Optional: panel ID to use when the panel isn't specified."
          }
        ]
      },
      welcome: {
        subtitle: "Welcome & goodbye messages, DMs, cards and autoroles.",
        hints:
          "Messages can use {mention}, {user}, {server}, {membercount}. Autoroles are comma-separated role IDs.",
        fields: [
          {
            key: "welcomeChannelId",
            label: "Welcome Channel ID",
            type: "text",
            description: "Text channel where welcome messages are sent."
          },
          {
            key: "welcomeMessage",
            label: "Welcome Message",
            type: "textarea",
            description:
              "Main welcome message. Supports {mention}, {user}, {server}, {membercount} and \\n for new lines."
          },
          {
            key: "welcomeDm",
            label: "Welcome DM Message",
            type: "textarea",
            description:
              "Optional DM message sent when a member joins. Supports the same placeholders."
          },
          {
            key: "goodbyeChannelId",
            label: "Goodbye Channel ID",
            type: "text",
            description: "Channel where goodbye messages are sent."
          },
          {
            key: "goodbyeMessage",
            label: "Goodbye Message",
            type: "textarea",
            description:
              "Message used when a member leaves the server. Supports the same placeholders."
          },
          {
            key: "goodbyeDm",
            label: "Goodbye DM Message",
            type: "textarea",
            description: "Optional DM sent when a member leaves."
          },
          {
            key: "autoroles",
            label: "Autoroles",
            type: "text",
            description: "Comma-separated role IDs that should be auto-assigned on join."
          },
          {
            key: "autoroleDelayMs",
            label: "Autorole Delay (ms)",
            type: "number",
            description: "Number of milliseconds to wait before giving autoroles (1000 = 1 second)."
          }
        ]
      },
      verification: {
        subtitle: "Captcha verification, roles, difficulty and logging.",
        hints:
          "Matches your /verify command. Difficulty presets: easy, medium, hard, manual.",
        fields: [
          {
            key: "panelChannelId",
            label: "Verification Panel Channel ID",
            type: "text",
            description: "Channel where the verification panel is sent."
          },
          {
            key: "logChannelId",
            label: "Verification Log Channel ID",
            type: "text",
            description: "Channel where verification logs are sent."
          },
          {
            key: "roles",
            label: "Verification Roles",
            type: "text",
            description: "Comma-separated role IDs assigned once a user passes verification."
          },
          {
            key: "staffRoleId",
            label: "Staff Role ID",
            type: "text",
            description:
              "Role ID allowed to manage verification, clear attempts and see logs."
          },
          {
            key: "message",
            label: "Panel Message",
            type: "textarea",
            description:
              "Message shown above the Verify button. Supports \\n for new lines."
          },
          {
            key: "difficultyMode",
            label: "Difficulty Mode",
            type: "text",
            description: "easy, medium, hard or manual."
          },
          {
            key: "difficultyLength",
            label: "Captcha Length (manual)",
            type: "number",
            description:
              "Number of characters when difficulty is manual. Leave blank to keep current."
          },
          {
            key: "difficultyDecoys",
            label: "Decoy Characters (manual)",
            type: "number",
            description:
              "Number of decoy characters when difficulty is manual. Leave blank to keep current."
          },
          {
            key: "difficultyTrace",
            label: "Trace Lines (manual; true/false)",
            type: "text",
            description:
              "Set to true or false when using manual mode to control trace lines."
          }
        ]
      },
      leveling: {
        subtitle: "XP system, level-up messages and role rewards.",
        hints:
          "Your /level command controls the same settings. Roles can be configured here as a quick overview.",
        fields: [
          {
            key: "xpPerMessage",
            label: "XP per Message",
            type: "number",
            description:
              "Base XP given per message (same as /level setxp)."
          },
          {
            key: "levelUpChannelId",
            label: "Level-Up Channel ID",
            type: "text",
            description:
              "Channel where level-up messages should be sent (same as /level setlevelchannel)."
          },
          {
            key: "roleRewards",
            label: "Role Rewards",
            type: "textarea",
            description:
              "Each line: level:ROLE_ID (e.g. 5:123456789012345678). The bot can parse this from Module.settings."
          }
        ]
      },
      logging: {
        subtitle: "Moderation log channel.",
        hints:
          "This mirrors your /set modlogs command. The bot can map this to GuildConfig.modLogChannelId.",
        fields: [
          {
            key: "modLogChannelId",
            label: "Moderation Log Channel ID",
            type: "text",
            description: "Channel used for warns, kicks, bans, etc."
          }
        ]
      },
      auditlogs: {
        subtitle: "Audit log channel.",
        hints:
          "Mirrors /set auditlogs. The bot can copy this to AuditGuildConfig.modLogChannelId.",
        fields: [
          {
            key: "auditLogChannelId",
            label: "Audit Log Channel ID",
            type: "text",
            description:
              "Channel for server join/leave and configuration change logs."
          }
        ]
      },
      vclogs: {
        subtitle: "Voice channel logging.",
        hints:
          "Mirrors /set vclogs, used by your VC logging model.",
        fields: [
          {
            key: "vcLogChannelId",
            label: "VC Log Channel ID",
            type: "text",
            description:
              "Channel where voice state updates (join/leave/move) are logged."
          }
        ]
      },
      muterole: {
        subtitle: "Global mute role configuration.",
        hints:
          "Mirrors /set muterole and is stored in your MuteRole model.",
        fields: [
          {
            key: "muteRoleId",
            label: "Mute Role ID",
            type: "text",
            description:
              "Role ID used when a user is muted by the moderation commands."
          }
        ]
      },
      lockown: {}, // typo guard
      lockdown: {
        subtitle: "Lockdown configuration.",
        hints:
          "This module is tied to your lockdown commands. You can store any extra settings you want here.",
        fields: [
          {
            key: "allowedRoles",
            label: "Roles allowed to run lockdown",
            type: "text",
            description: "Comma-separated role IDs that can manage lockdown."
          }
        ]
      },
      antiraid: {
        subtitle: "Anti-raid thresholds.",
        hints:
          "Exact thresholds are up to you inside the bot; this is just a configuration store.",
        fields: [
          {
            key: "joinThreshold",
            label: "Join Threshold",
            type: "number",
            description:
              "Approx. number of joins per minute that should trigger the anti-raid system."
          },
          {
            key: "timeWindowSec",
            label: "Time Window (seconds)",
            type: "number",
            description:
              "How many seconds to observe joins before declaring a raid."
          }
        ]
      },
      automod: {
        subtitle: "Automatic filter settings.",
        hints:
          "Use booleans like true/false or comma-separated lists. The bot can read from Module.settings when handling messages.",
        fields: [
          {
            key: "blockLinks",
            label: "Block Links (true/false)",
            type: "text",
            description: "Whether to silently block links sent by members."
          },
          {
            key: "blockInvites",
            label: "Block Discord Invites (true/false)",
            type: "text",
            description: "Whether to block Discord invite links."
          },
          {
            key: "blacklistedWords",
            label: "Blacklisted Words",
            type: "textarea",
            description: "One word or phrase per line to block."
          }
        ]
      }
    };

    // ========= LOAD USER & GUILD =========
    async function loadUser() {
      try {
        const res = await fetch("/api/user", { headers: authHeader });
        if (!res.ok) throw new Error("User fetch failed");
        const data = await res.json();
        if (!data.loggedIn) {
          localStorage.removeItem("safeguard_token");
          localStorage.removeItem("sg_token");
          localStorage.removeItem("token");
          window.location.href = "/auth/discord";
          return;
        }

        const u = data.user;
        userNameEl.textContent = `${u.username}#${u.discriminator}`;
        if (u.avatar) {
          userAvatarEl.src = `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64`;
        }
      } catch (err) {
        console.error("User load error:", err);
      }
    }

    async function loadModules() {
      try {
        statusText.textContent = "Loading modules‚Ä¶";
        const res = await fetch(`/api/modules/${guildId}`, { headers: authHeader });
        if (!res.ok) throw new Error("Module fetch failed");
        const modules = await res.json();

        if (!Array.isArray(modules) || !modules.length) {
          currentModules = [];
          modulesGrid.innerHTML =
            '<p style="color: var(--text-muted); font-size: 14px;">No modules found for this guild.</p>';
          guildLabel.textContent = `Guild ID ${guildId}`;
          statusText.textContent = "No modules available.";
          return;
        }

        currentModules = modules;
        renderModules(modules);
        guildLabel.textContent = `Configuring guild ID ${guildId}`;
        statusText.textContent = "Modules loaded. Changes save instantly.";
      } catch (err) {
        console.error("Modules load error:", err);
        statusText.textContent = "Failed to load modules from API.";
      }
    }

    function renderModules(mods) {
      modulesGrid.innerHTML = "";
      if (!Array.isArray(mods) || !mods.length) {
        modulesGrid.innerHTML =
          '<p style="color: var(--text-muted); font-size: 14px;">No modules found for this guild.</p>';
        return;
      }

      for (const mod of mods) {
        const card = document.createElement("article");
        card.className = "module-card";

        const def = MODULE_DEFINITIONS[mod.id] || {};
        const subtitle = def.subtitle || "";
        const description = mod.description || subtitle || "No description provided.";

        card.innerHTML = `
          <div class="module-card-inner">
            <div class="module-chip-row">
              <div class="module-name">${mod.name}</div>
              <label class="toggle">
                <input type="checkbox" ${mod.enabled ? "checked" : ""} data-module-id="${mod._id}">
                <span class="slider"></span>
              </label>
            </div>
            <div class="module-desc">${description}</div>
            <div class="module-footer">
              <span class="badge ${mod.enabled ? "badge-on" : ""}">
                ${mod.enabled ? "Enabled" : "Disabled"}
              </span>
              <button class="btn-ghost" data-configure-id="${mod._id}">
                ‚öô Configure
              </button>
            </div>
          </div>
        `;

        modulesGrid.appendChild(card);
      }

      // Attach listeners
      modulesGrid.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.addEventListener("change", onToggleModule);
      });

      modulesGrid.querySelectorAll("[data-configure-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-configure-id");
          const mod = currentModules.find(m => m._id === id);
          if (mod) openModuleModal(mod);
        });
      });
    }

    async function onToggleModule(e) {
      const moduleId = e.target.getAttribute("data-module-id");
      const enabled = e.target.checked;
      // Optimistic UI: update badge immediately
      const card = e.target.closest(".module-card");
      const badge = card.querySelector(".badge");
      badge.textContent = enabled ? "Enabled" : "Disabled";
      badge.classList.toggle("badge-on", enabled);

      try {
        const res = await fetch(`/api/modules/toggle/${moduleId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...authHeader
          }
        });
        if (!res.ok) throw new Error("Toggle failed");
      } catch (err) {
        console.error("Toggle error:", err);
        e.target.checked = !enabled; // revert
        badge.textContent = !enabled ? "Enabled" : "Disabled";
        badge.classList.toggle("badge-on", !enabled);
        alert("Failed to toggle module. Check API logs.");
      }
    }

    // ========= MODAL LOGIC =========
    function openModuleModal(mod) {
      currentModule = mod;

      const def = MODULE_DEFINITIONS[mod.id] || { fields: [] };
      modalTitle.textContent = mod.name;
      modalSubtitle.textContent =
        def.subtitle || "Edit configuration for this module.";
      document.getElementById("modalHints").textContent =
        def.hints ||
        "Values here are stored in Module.settings in MongoDB. Your bot can read them and sync to its own models.";

      // Build fields
      modalFields.innerHTML = "";
      const settings = mod.settings || {};

      const fields = def.fields || [];
      if (!fields.length) {
        const p = document.createElement("p");
        p.textContent =
          "This module currently has no specific editor. You can still toggle it on/off from the main view.";
        p.style.fontSize = "13px";
        p.style.color = "var(--text-muted)";
        modalFields.appendChild(p);
      } else {
        for (const field of fields) {
          const wrapper = document.createElement("div");
          wrapper.className = "field-group";

          const label = document.createElement("div");
          label.className = "field-label";
          label.textContent = field.label;

          const desc = document.createElement("div");
          desc.className = "field-description";
          desc.textContent = field.description || "";

          let input;
          if (field.type === "textarea") {
            input = document.createElement("textarea");
          } else {
            input = document.createElement("input");
            input.type = field.type || "text";
          }
          input.name = field.key;
          if (settings[field.key] !== undefined && settings[field.key] !== null) {
            input.value = String(settings[field.key]);
          }

          wrapper.appendChild(label);
          if (field.description) wrapper.appendChild(desc);
          wrapper.appendChild(input);
          modalFields.appendChild(wrapper);
        }
      }

      saveStatus.innerHTML =
        '<span class="icon">üíæ</span><span>Waiting for changes‚Ä¶</span>';
      modalBackdrop.classList.add("show");
    }

    function closeModuleModal() {
      modalBackdrop.classList.remove("show");
      currentModule = null;
    }

    async function saveModuleSettings() {
      if (!currentModule) return;

      const formData = new FormData(moduleForm);
      const settings = {};
      for (const [key, value] of formData.entries()) {
        // include empties so you can clear values
        settings[key] = value.trim();
      }

      saveStatus.innerHTML =
        '<span class="icon">‚è≥</span><span>Saving to MongoDB‚Ä¶</span>';

      try {
        const res = await fetch(`/api/modules/update/${currentModule._id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...authHeader
          },
          body: JSON.stringify({ settings })
        });
        if (!res.ok) throw new Error("Save failed");
        const data = await res.json();

        // Update in-memory copy
        currentModule.settings = data.settings;
        const idx = currentModules.findIndex(m => m._id === currentModule._id);
        if (idx !== -1) currentModules[idx] = currentModule;

        saveStatus.innerHTML =
          '<span class="icon">‚úÖ</span><span>Saved. Bot will pick up changes via Mongo.</span>';
      } catch (err) {
        console.error("Save settings error:", err);
        saveStatus.innerHTML =
          '<span class="icon">‚ùå</span><span>Failed to save. Check API logs.</span>';
      }
    }

    function resetModuleForm() {
      if (!currentModule) return;
      openModuleModal(currentModule); // simply re-open with current in-memory data
      saveStatus.innerHTML =
        '<span class="icon">üíæ</span><span>Form reset to last saved values.</span>';
    }

    // ========= NAV + EVENTS =========
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "/dashboard";
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("safeguard_token");
      localStorage.removeItem("sg_token");
      localStorage.removeItem("token");
      window.location.href = "/";
    });

    document.getElementById("closeModalBtn").addEventListener("click", closeModuleModal);
    document.getElementById("saveFormBtn").addEventListener("click", saveModuleSettings);
    document.getElementById("resetFormBtn").addEventListener("click", resetModuleForm);

    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModuleModal();
    });

    // ========= INIT =========
    (async function init() {
      await loadUser();
      await loadModules();
    })();
  </script>
</body>
</html>
