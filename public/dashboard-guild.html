<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Safeguard ‚Äì Server Modules</title>
  <link rel="icon" href="https://i.postimg.cc/4y7fpLWq/Safe-Guard-Bot.png" />
  <style>
    :root {
      --bg-main: #04060d;
      --bg-sidebar: #050816;
      --bg-card: #0b1220;
      --bg-soft: #111827;
      --accent: #ff6600;
      --accent-soft: #ff944d;
      --accent-soft2: rgba(255, 148, 77, 0.18);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-muted: #6b7280;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.65);
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
        sans-serif;
    }

    body {
      background: radial-gradient(circle at 0% 0%, #0b1220, #050816 55%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Top bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 40;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 32px;
      backdrop-filter: blur(18px);
      background: linear-gradient(
        to right,
        rgba(4, 6, 13, 0.95),
        rgba(5, 8, 22, 0.9)
      );
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .topbar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar-logo img {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
    }

    .topbar-logo-text {
      display: flex;
      flex-direction: column;
    }

    .topbar-logo-text span:first-child {
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.04em;
      color: var(--accent);
    }

    .topbar-logo-text span:last-child {
      font-size: 0.78rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: 1px solid transparent;
      font-size: 0.85rem;
      padding: 7px 16px;
      cursor: pointer;
      transition: 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: none;
      color: var(--text-main);
    }

    .btn-ghost {
      border-color: rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.7);
    }

    .btn-ghost:hover {
      border-color: var(--accent-soft);
      background: rgba(15, 23, 42, 0.95);
      color: var(--accent-soft);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      border-color: rgba(248, 250, 252, 0.3);
      color: #111827;
      font-weight: 600;
      box-shadow: 0 10px 28px rgba(248, 113, 22, 0.5);
    }

    .btn-primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .user-pill img {
      width: 26px;
      height: 26px;
      border-radius: 999px;
    }

    .user-pill span {
      font-size: 0.83rem;
      color: var(--text-soft);
    }

    /* Layout */
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 0;
      padding: 26px 32px 32px;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
        padding-inline: 16px;
      }
    }

    /* Sidebar */
    .sidebar {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: var(--shadow-soft);
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: relative;
      overflow: hidden;
    }

    .sidebar::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(
        circle at 10% 0%,
        rgba(248, 113, 22, 0.24),
        transparent 55%
      );
      opacity: 0.7;
    }

    .sidebar-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
      height: 100%;
    }

    .sidebar-guild {
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(248, 250, 252, 0.1);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-guild-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }

    .sidebar-guild-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-guild-pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.03);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-soft);
    }

    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .sidebar-user img {
      width: 30px;
      height: 30px;
      border-radius: 999px;
    }

    .sidebar-user-main {
      display: flex;
      flex-direction: column;
    }

    .sidebar-user-main span:first-child {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .sidebar-user-main span:last-child {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .sidebar-nav {
      margin-top: 4px;
      padding-top: 8px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .sidebar-section-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
      margin: 14px 3px 6px;
    }

    .sidebar-nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 0.82rem;
      color: var(--text-soft);
      cursor: pointer;
      transition: 0.18s ease;
    }

    .sidebar-nav-item:hover {
      background: rgba(15, 23, 42, 0.9);
      color: var(--accent-soft);
    }

    .sidebar-nav-item.active {
      background: rgba(15, 23, 42, 0.95);
      color: var(--accent);
      box-shadow: 0 0 16px rgba(248, 113, 22, 0.4);
    }

    .sidebar-nav-indicator {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.6);
    }

    .sidebar-nav-item.active .sidebar-nav-indicator {
      background: var(--accent);
    }

    /* Content side */
    .content {
      padding-left: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    @media (max-width: 960px) {
      .content {
        padding-left: 0;
        margin-top: 16px;
      }
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .content-header-main h1 {
      font-size: 1.7rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .content-header-main p {
      font-size: 0.9rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .changes-badge {
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.8rem;
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
    }

    .status-text {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .modules-container {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .group-block {
      padding: 18px 18px 18px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: radial-gradient(circle at 10% 0%, #0f172a, #020617);
      box-shadow: var(--shadow-soft);
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 16px;
    }

    .group-header h2 {
      font-size: 1.1rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .group-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .module-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .module-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: linear-gradient(
        145deg,
        rgba(15, 23, 42, 0.96),
        rgba(7, 10, 20, 0.98)
      );
      padding: 16px 15px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
      cursor: default;
      transition: transform 0.16s ease, box-shadow 0.18s ease,
        border-color 0.18s ease;
    }

    .module-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(
        circle at 0% 0%,
        rgba(248, 113, 22, 0.25),
        transparent 50%
      );
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .module-card:hover {
      transform: translateY(-3px);
      border-color: rgba(248, 113, 22, 0.5);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
    }

    .module-card:hover::before {
      opacity: 0.9;
    }

    .module-card-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .module-chip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .module-name {
      font-size: 0.98rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .module-badge {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .module-desc {
      font-size: 0.85rem;
      color: var(--text-soft);
      line-height: 1.45;
    }

    .module-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 4px;
    }

    .badge {
      font-size: 0.75rem;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
    }

    .badge-on {
      border-color: rgba(34, 197, 94, 0.7);
      background: rgba(22, 163, 74, 0.15);
      color: #bbf7d0;
    }

    .btn-ghost-sm {
      font-size: 0.76rem;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: 0.18s ease;
    }

    .btn-ghost-sm:hover {
      color: var(--accent-soft);
      border-color: var(--accent-soft);
      background: rgba(15, 23, 42, 1);
    }

    /* Toggle switch */
    .toggle {
      position: relative;
      width: 44px;
      height: 22px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #111827;
      border-radius: 999px;
      transition: 0.2s ease;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.5);
    }

    .toggle .slider::before {
      content: "";
      position: absolute;
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: #f9fafb;
      border-radius: 999px;
      transition: 0.2s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
    }

    .toggle input:checked + .slider {
      background: radial-gradient(circle at 0% 0%, #f97316, #ea580c);
      box-shadow: 0 0 12px rgba(248, 113, 22, 0.6);
    }

    .toggle input:checked + .slider::before {
      transform: translateX(20px);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(18px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 720px;
      max-height: 90vh;
      overflow: hidden;
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at 0% 0%, #111827, #020617);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px 18px 10px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.95);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .modal-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .modal-title-block h2 {
      font-size: 1.15rem;
    }

    .modal-title-block span {
      font-size: 0.83rem;
      color: var(--text-soft);
    }

    .modal-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .modal-hints {
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      font-size: 0.8rem;
      color: var(--text-soft);
      max-width: 260px;
    }

    .modal-body {
      padding: 12px 18px 16px;
      overflow-y: auto;
      flex: 1;
    }

    .field-group {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-label {
      font-size: 0.8rem;
      color: var(--text-main);
      font-weight: 500;
    }

    .field-description {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .field-group input,
    .field-group textarea {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      padding: 7px 9px;
      font-size: 0.85rem;
      color: var(--text-main);
      resize: vertical;
      min-height: 34px;
    }

    .field-group textarea {
      min-height: 70px;
    }

    .field-group input:focus,
    .field-group textarea:focus {
      outline: none;
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(248, 113, 22, 0.5);
    }

    .modal-footer {
      padding: 10px 18px 14px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .save-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .save-status .icon {
      font-size: 0.9rem;
    }

    .btn-row {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      font-size: 0.8rem;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.18s ease;
    }

    .btn-sm.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #111827;
      border-color: rgba(248, 250, 252, 0.4);
    }

    .btn-sm.danger {
      border-color: rgba(239, 68, 68, 0.8);
      color: #fecaca;
    }

    .btn-sm:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 18px;
      right: 18px;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      z-index: 60;
      animation: toast-in 0.25s ease-out;
    }

    .toast.success {
      background: rgba(34, 197, 94, 0.95);
    }

    .toast.error {
      background: rgba(239, 68, 68, 0.95);
    }

    .toast.info {
      background: rgba(59, 130, 246, 0.95);
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <button id="backBtn" class="btn btn-ghost">
        ‚Üê Back to servers
      </button>
      <div class="topbar-logo">
        <a href="/home" class="nav-logo-link">
          <img src="/assets/Safeguard-Bot.png" alt="Safeguard" />
          <div class="topbar-logo-text">
            <span>Safeguard</span>
            <span>Discord Security Panel</span>
          </div>
        </a>
      </div>
    </div>
    <div class="topbar-actions">
      <div class="user-pill">
        <img id="userAvatar" src="/assets/Safeguard-Bot.png" alt="User" />
        <span id="userName">Loading‚Ä¶</span>
      </div>
      <button id="logoutBtn" class="btn btn-ghost">Logout</button>
    </div>
  </header>

  <main class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-guild">
          <div class="sidebar-guild-title">Active server</div>
          <div class="sidebar-guild-name">
            <span id="sidebarGuild">Loading‚Ä¶</span>
            <span class="sidebar-guild-pill">Safeguard Config</span>
          </div>
        </div>

        <div class="sidebar-user">
          <img
            id="sidebarUserAvatar"
            src="/assets/Safeguard-Bot.png"
            alt="User"
          />
          <div class="sidebar-user-main">
            <span id="sidebarUserName">Loading‚Ä¶</span>
            <span>logged in via Discord</span>
          </div>
        </div>

        <nav id="sidebarNav" class="sidebar-nav">
          <!-- Filled by JS -->
        </nav>
      </div>
    </aside>

    <!-- Content -->
    <section class="content">
      <div class="content-header">
        <div class="content-header-main">
          <h1 id="pageTitle">Server Modules</h1>
          <p id="pageSubtitle">Loading guild information‚Ä¶</p>
        </div>
        <div id="changesBadge" class="changes-badge">
          <span class="status-dot"></span>
          <span>All changes saved</span>
        </div>
      </div>

      <p id="statusText" class="status-text">Loading modules‚Ä¶</p>

      <div id="modulesContainer" class="modules-container"></div>
    </section>
  </main>

  <!-- Modal for module settings -->
  <div id="moduleModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <form id="moduleForm">
        <div class="modal-header">
          <div class="modal-title-block">
            <h2 id="modalTitle">Module</h2>
            <span id="modalSubtitle">Configure this module's settings.</span>
          </div>
          <div class="modal-header-right">
            <div id="modalHints" class="modal-hints">
              Hints will appear here based on the selected module.
            </div>
            <button type="button" id="closeModalBtn" class="btn-sm danger">
              ‚úï Close
            </button>
          </div>
        </div>

        <div id="modalFields" class="modal-body">
          <!-- Dynamic fields injected by JS -->
        </div>

        <div class="modal-footer">
          <div id="saveStatus" class="save-status">
            <span class="icon">üíæ</span>
            <span>Waiting for changes‚Ä¶</span>
          </div>
          <div class="btn-row">
            <button type="button" id="resetFormBtn" class="btn-sm">
              Reset
            </button>
            <button type="button" id="saveFormBtn" class="btn-sm primary">
              Save changes
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ====== UTIL / GLOBAL STATE ======
    // Get guildId from ?guild= in the URL, e.g. /dashboard-guild.html?guild=123
    const urlParams = new URLSearchParams(window.location.search);
    const guildId = urlParams.get("guild");

    if (!guildId) {
      console.warn("No guild id in query (?guild=ID). Redirecting.");
      window.location.href = "/dashboard.html";
    }

    // ‚úÖ Single token declaration
    const token =
      localStorage.getItem("safeguard_token") ||
      localStorage.getItem("sg_token") ||
      localStorage.getItem("token");

    if (!token) {
      console.warn("No token found in localStorage. API routes that require auth may fail.");
    }

    const authHeader = token
      ? { Authorization: "Bearer " + token }
      : {};

    const sidebarGuild = document.getElementById("sidebarGuild");
    const sidebarNav = document.getElementById("sidebarNav");
    const statusText = document.getElementById("statusText");
    const modulesContainer = document.getElementById("modulesContainer");
    const userNameEl = document.getElementById("userName");
    const userAvatarEl = document.getElementById("userAvatar");
    const sidebarUserName = document.getElementById("sidebarUserName");
    const sidebarUserAvatar = document.getElementById("sidebarUserAvatar");
    const pageTitle = document.getElementById("pageTitle");
    const pageSubtitle = document.getElementById("pageSubtitle");
    const changesBadge = document.getElementById("changesBadge");

    const modalBackdrop = document.getElementById("moduleModalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubtitle = document.getElementById("modalSubtitle");
    const modalFields = document.getElementById("modalFields");
    const modalHints = document.getElementById("modalHints");
    const moduleForm = document.getElementById("moduleForm");
    const saveStatus = document.getElementById("saveStatus");

    let currentModules = [];
    let currentModule = null;

    // Field definitions for each module
    const MODULE_DEFINITIONS = {
      welcome: {
        group: "General",
        subtitle: "Welcome & goodbye messages, DMs and autoroles.",
        hints:
          "Use {mention}, {user}, {server}, {membercount} in messages. Autoroles is a comma-separated list of role IDs.",
        fields: [
          {
            key: "welcomeChannelId",
            label: "Welcome Channel ID",
            type: "text",
            description: "Channel where welcome messages are sent.",
          },
          {
            key: "welcomeMessage",
            label: "Welcome Message",
            type: "textarea",
            description:
              "Main welcome message. Supports placeholders and \\n for new lines.",
          },
          {
            key: "welcomeDm",
            label: "Welcome DM Message",
            type: "textarea",
            description:
              "Optional DM sent when a member joins.",
          },
          {
            key: "goodbyeChannelId",
            label: "Goodbye Channel ID",
            type: "text",
            description: "Channel for leave messages.",
          },
          {
            key: "goodbyeMessage",
            label: "Goodbye Message",
            type: "textarea",
            description:
              "Message when a member leaves.",
          },
          {
            key: "goodbyeDm",
            label: "Goodbye DM Message",
            type: "textarea",
            description:
              "Optional DM sent when a member leaves.",
          },
          {
            key: "autoroles",
            label: "Autoroles (comma-separated role IDs)",
            type: "text",
            description: "Example: 123,456,789",
          },
          {
            key: "autoroleDelayMs",
            label: "Autorole Delay (ms)",
            type: "number",
            description: "Delay before giving autoroles (1000 = 1s).",
          },
        ],
      },
      verification: {
        group: "General",
        subtitle: "Captcha verification, roles and logging.",
        hints:
          "Difficulty modes: easy, medium, hard, manual. Roles is a comma-separated list of role IDs given after verification.",
        fields: [
          {
            key: "panelChannelId",
            label: "Verification Panel Channel ID",
            type: "text",
            description:
              "Channel where the verification panel is sent.",
          },
          {
            key: "logChannelId",
            label: "Verification Log Channel ID",
            type: "text",
            description: "Channel for verification logs.",
          },
          {
            key: "roles",
            label: "Roles (comma-separated IDs)",
            type: "text",
            description: "Roles to grant after success.",
          },
          {
            key: "staffRoleId",
            label: "Staff Role ID",
            type: "text",
            description:
              "Role that can manage verification.",
          },
          {
            key: "message",
            label: "Panel Message",
            type: "textarea",
            description: "Text shown above the Verify button.",
          },
          {
            key: "difficultyMode",
            label: "Difficulty Mode",
            type: "text",
            description: "easy, medium, hard, manual",
          },
          {
            key: "difficultyLength",
            label: "Captcha Length (manual)",
            type: "number",
            description:
              "Number of characters when using manual mode.",
          },
          {
            key: "difficultyDecoys",
            label: "Decoy Characters (manual)",
            type: "number",
            description: "Number of decoys in manual mode.",
          },
          {
            key: "difficultyTrace",
            label: "Trace Lines (true/false)",
            type: "text",
            description:
              "Whether to draw trace lines in captcha.",
          },
        ],
      },
      logging: {
        group: "General",
        subtitle: "Moderation log channel.",
        hints:
          "This is used for warns, kicks, bans, timeouts and similar actions.",
        fields: [
          {
            key: "modLogChannelId",
            label: "Moderation Log Channel ID",
            type: "text",
            description:
              "Channel ID where moderation logs are sent.",
          },
        ],
      },
      auditlogs: {
        group: "General",
        subtitle: "Audit logs channel.",
        hints: "Join/leave, configuration, and general audit logging.",
        fields: [
          {
            key: "auditLogChannelId",
            label: "Audit Log Channel ID",
            type: "text",
            description:
              "Channel ID used for audit logs.",
          },
        ],
      },
      vclogs: {
        group: "General",
        subtitle: "Voice channel logging.",
        hints:
          "Tracks join, leave and move events for voice channels.",
        fields: [
          {
            key: "vcLogChannelId",
            label: "VC Log Channel ID",
            type: "text",
            description: "Channel where VC logs are posted.",
          },
        ],
      },
      adminrole: {
        group: "General",
        subtitle: "SafeGuard admin role.",
        hints:
          "This role can use high-level Safeguard commands and dashboard actions if you wire it in the bot.",
        toggle: false,
        fields: [
          {
            key: "adminRoleId",
            label: "Admin Role ID",
            type: "text",
            description:
              "Role ID that should be treated as Safeguard admin.",
          },
        ],
      },
      muterole: {
        group: "General",
        subtitle: "Global mute role.",
        hints:
          "Used by your mute commands. Typically a role that denies Send Messages everywhere.",
        toggle: false,
        fields: [
          {
            key: "muteRoleId",
            label: "Mute Role ID",
            type: "text",
            description:
              "Role ID used when a member is muted.",
          },
        ],
      },
      lockdown: {
        group: "General",
        subtitle: "Lockdown behavior.",
        hints:
          "Channel roles/server roles are used by your lockdown system to decide who keeps access.",
        fields: [
          {
            key: "channelRoles",
            label: "Channel Roles (comma-separated)",
            type: "text",
            description:
              "Roles that keep per-channel permissions during lockdown.",
          },
          {
            key: "serverRoles",
            label: "Server Roles (comma-separated)",
            type: "text",
            description:
              "Roles that keep global permissions during lockdown.",
          },
        ],
      },
      botstatus: {
        group: "General",
        subtitle: "Bot status channel.",
        hints:
          "Channel where the bot posts its status message. Your bot should update it on restart/ping.",
        toggle: false,
        fields: [
          {
            key: "statusChannelId",
            label: "Status Channel ID",
            type: "text",
            description: "Channel ID for the bot status message.",
          },
        ],
      },

      antiraid: {
        group: "Protection",
        subtitle: "Anti-raid thresholds.",
        hints:
          "These values should match what your bot expects when checking join rates.",
        fields: [
          {
            key: "joinThreshold",
            label: "Join Threshold",
            type: "number",
            description:
              "Approx number of joins in a window that triggers anti-raid.",
          },
          {
            key: "timeWindowSec",
            label: "Time Window (seconds)",
            type: "number",
            description:
              "Time window used when counting joins.",
          },
          {
            key: "autoLockdown",
            label: "Auto Lockdown (true/false)",
            type: "text",
            description:
              "If true, automatically triggers lockdown on raids.",
          },
        ],
      },
      automod: {
        group: "Protection",
        subtitle: "Automatic filters.",
        hints:
          "The bot should read these values to enforce anti-link, anti-invite and word filters.",
        fields: [
          {
            key: "blockLinks",
            label: "Block Links (true/false)",
            type: "text",
            description:
              "Whether to block links from regular members.",
          },
          {
            key: "blockInvites",
            label: "Block Discord Invites (true/false)",
            type: "text",
            description:
              "Whether to block Discord invites.",
          },
          {
            key: "blacklistedWords",
            label: "Blacklisted Words (one per line)",
            type: "textarea",
            description:
              "Each line is a blocked word/phrase.",
          },
        ],
      },
      punishments: {
        group: "Protection",
        subtitle: "Warn ‚Üí punishment mapping.",
        hints:
          "Each line: warningCount:action:durationMinutes. Example: 3:timeout:60 or 5:kick: or 7:ban:",
        fields: [
          {
            key: "rules",
            label: "Rules",
            type: "textarea",
            description:
              "One rule per line, format: warnings:action:durationMinutes(optional).",
          },
        ],
      },

      leveling: {
        group: "Engagement",
        subtitle: "XP system & level rewards.",
        hints:
          "Your bot should sync these values to how it calculates XP and level rewards.",
        fields: [
          {
            key: "xpPerMessage",
            label: "XP per Message",
            type: "number",
            description: "Base XP given per message.",
          },
          {
            key: "levelUpChannelId",
            label: "Level-Up Channel ID",
            type: "text",
            description: "Channel for level-up messages.",
          },
          {
            key: "roleRewards",
            label: "Role Rewards (one per line)",
            type: "textarea",
            description:
              "Each line: level:ROLE_ID (e.g. 5:123456789012345678).",
          },
        ],
      },
      sticky: {
        group: "Engagement",
        subtitle: "Sticky messages.",
        hints:
          "These settings control who can manage stickies and the default restick interval.",
        fields: [
          {
            key: "staffRoleIds",
            label: "Staff Role IDs (comma-separated)",
            type: "text",
            description:
              "Roles that can configure sticky messages.",
          },
          {
            key: "defaultIntervalMs",
            label: "Default Interval (ms)",
            type: "number",
            description:
              "Delay between resticking messages (60000 = 1 minute).",
          },
        ],
      },
      announcements: {
        group: "Engagement",
        subtitle: "Announcement defaults.",
        hints:
          "Used as defaults for announcement commands in your bot.",
        fields: [
          {
            key: "defaultChannelId",
            label: "Default Announcement Channel ID",
            type: "text",
            description:
              "Channel to use when a command doesn't specify one.",
          },
          {
            key: "pingRoles",
            label: "Ping Roles (comma-separated IDs)",
            type: "text",
            description: "Roles to ping on announcements.",
          },
        ],
      },
      giveaways: {
        group: "Engagement",
        subtitle: "Giveaway defaults.",
        hints:
          "Your bot can read these to prefill giveaway duration/winners/channel.",
        fields: [
          {
            key: "defaultChannelId",
            label: "Default Giveaway Channel ID",
            type: "text",
            description: "Channel to use for giveaways.",
          },
          {
            key: "defaultDurationMinutes",
            label: "Default Duration (minutes)",
            type: "number",
            description:
              "Length of giveaways if no duration is specified.",
          },
          {
            key: "defaultWinners",
            label: "Default Winners Count",
            type: "number",
            description:
              "Number of winners if not specified.",
          },
        ],
      },
      polls: {
        group: "Engagement",
        subtitle: "Poll defaults.",
        hints:
          "Your bot can use these defaults for quick polls.",
        fields: [
          {
            key: "defaultChannelId",
            label: "Default Poll Channel ID",
            type: "text",
            description: "Channel to use for polls.",
          },
          {
            key: "requireRoleIds",
            label: "Required Role IDs (comma-separated)",
            type: "text",
            description:
              "Only these roles can vote/create polls (if your bot uses this).",
          },
        ],
      },
      tickets: {
        group: "Engagement",
        subtitle: "Ticket system defaults.",
        hints:
          "Your /ticket commands should read these values to decide where to create tickets and who handles them.",
        fields: [
          {
            key: "panelChannel",
            label: "Ticket Panel Channel ID",
            type: "text",
            description:
              "Channel where ticket panel is posted.",
          },
          {
            key: "supportRole",
            label: "Support Role ID",
            type: "text",
            description:
              "Role that gets pings on new tickets.",
          },
          {
            key: "ticketCategory",
            label: "Ticket Category ID",
            type: "text",
            description:
              "Category where new tickets are created.",
          },
        ],
      },
    };

    const GROUP_ORDER = ["General", "Protection", "Engagement"];

    // ====== TOAST HELPER ======
    function showToast(message, type = "info") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // ====== LOAD USER ======
    async function loadUser() {
      try {
        const res = await fetch("/api/user", { headers: authHeader });
        const data = await res.json();
        if (!data.loggedIn) {
          localStorage.removeItem("safeguard_token");
          localStorage.removeItem("sg_token");
          localStorage.removeItem("token");
          window.location.href = "/auth/discord";
          return;
        }
        const u = data.user;
        const name = `${u.username}#${u.discriminator}`;
        userNameEl.textContent = name;
        sidebarUserName.textContent = name;
        if (u.avatar) {
          const url = `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64`;
          userAvatarEl.src = url;
          sidebarUserAvatar.src = url;
        }
      } catch (err) {
        console.error("User load error:", err);
      }
    }

    // ====== LOAD MODULES ======
    async function loadModules() {
      try {
        statusText.textContent = "Loading modules‚Ä¶";
        const res = await fetch(`/api/modules/${guildId}`, {
          headers: authHeader,
        });
        if (!res.ok) throw new Error("Module fetch failed");
        const modules = await res.json();
        if (!Array.isArray(modules) || !modules.length) {
          modulesContainer.innerHTML =
            '<p style="color: var(--text-muted); font-size: 14px;">No modules found for this guild.</p>';
          statusText.textContent = "No modules available.";
          sidebarGuild.textContent = `Guild ${guildId}`;
          pageSubtitle.textContent = `Configuring guild ID ${guildId}`;
          return;
        }
        currentModules = modules;
        renderModules(modules);
        sidebarGuild.textContent = `Guild ID ${guildId}`;
        pageSubtitle.textContent = `Configuring guild ID ${guildId}`;
        statusText.textContent =
          "Modules loaded. Use toggles & Configure buttons to update.";
      } catch (err) {
        console.error("Modules load error:", err);
        statusText.textContent = "Failed to load modules from API.";
        modulesContainer.innerHTML =
          '<p style="color: #f97373; font-size: 14px;">Failed to load modules. Check API logs.</p>';
      }
    }

    function renderModules(mods) {
      modulesContainer.innerHTML = "";
      sidebarNav.innerHTML = "";

      const modsByGroup = {};
      for (const mod of mods) {
        const def = MODULE_DEFINITIONS[mod.id] || {};
        const group = def.group || mod.group || "General";
        if (!modsByGroup[group]) modsByGroup[group] = [];
        modsByGroup[group].push(mod);
      }

      // Sidebar nav
      GROUP_ORDER.forEach((group) => {
        if (!modsByGroup[group] || !modsByGroup[group].length) return;

        const groupWrap = document.createElement("div");
        groupWrap.className = "sidebar-nav-group";

        const label = document.createElement("div");
        label.className = "sidebar-section-label";
        label.textContent = group;
        groupWrap.appendChild(label);

        modsByGroup[group].forEach((mod) => {
          const item = document.createElement("div");
          item.className = "sidebar-nav-item";
          item.dataset.target = `module-${mod.id}`;
          item.innerHTML = `
            <span class="sidebar-nav-indicator"></span>
            <span>${mod.name}</span>
          `;
          item.addEventListener("click", () => {
            document
              .getElementById(`module-${mod.id}`)
              ?.scrollIntoView({ behavior: "smooth", block: "start" });
            sidebarNav
              .querySelectorAll(".sidebar-nav-item")
              .forEach((el) => el.classList.remove("active"));
            item.classList.add("active");
          });
          groupWrap.appendChild(item);
        });

        sidebarNav.appendChild(groupWrap);
      });

      // Main cards grouped by group
      GROUP_ORDER.forEach((group) => {
        const groupMods = modsByGroup[group];
        if (!groupMods || !groupMods.length) return;

        const block = document.createElement("section");
        block.className = "group-block";

        const header = document.createElement("div");
        header.className = "group-header";
        header.innerHTML = `
          <h2>${group}</h2>
          <span>${groupMods.length} module${groupMods.length > 1 ? "s" : ""}</span>
        `;
        block.appendChild(header);

        const grid = document.createElement("div");
        grid.className = "module-grid";

        for (const mod of groupMods) {
          const card = document.createElement("article");
          card.className = "module-card";
          card.id = `module-${mod.id}`;

          const def = MODULE_DEFINITIONS[mod.id] || {};
          const subtitle = def.subtitle || "";
          const description =
            mod.description || subtitle || "No description provided.";
          const showToggle = def.toggle !== false;

          card.innerHTML = `
            <div class="module-card-inner">
              <div class="module-chip-row">
                <div class="module-name">
                  ${mod.name}
                  <span class="module-badge">${group}</span>
                </div>
                ${
                  showToggle
                    ? `<label class="toggle">
                        <input type="checkbox" ${
                          mod.enabled ? "checked" : ""
                        } data-module-id="${mod.id}">
                        <span class="slider"></span>
                      </label>`
                    : ""
                }
              </div>
              <div class="module-desc">${description}</div>
              <div class="module-footer">
                <span class="badge ${mod.enabled ? "badge-on" : ""}">
                  ${mod.enabled ? "Enabled" : "Disabled"}
                </span>
                <button class="btn-ghost-sm" data-configure-id="${mod.id}">
                  ‚öô Configure
                </button>
              </div>
            </div>
          `;

          grid.appendChild(card);
        }

        block.appendChild(grid);
        modulesContainer.appendChild(block);
      });

      // Attach listeners
      modulesContainer
        .querySelectorAll('input[type="checkbox"]')
        .forEach((input) => {
          input.addEventListener("change", onToggleModule);
        });
      modulesContainer
        .querySelectorAll("[data-configure-id]")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-configure-id");
            const mod = currentModules.find((m) => m.id === id);
            if (mod) openModuleModal(mod);
          });
        });
    }

    async function onToggleModule(e) {
      const moduleId = e.target.getAttribute("data-module-id");
      const enabled = e.target.checked;
      const card = e.target.closest(".module-card");
      const badge = card.querySelector(".badge");

      // optimistic UI
      badge.textContent = enabled ? "Enabled" : "Disabled";
      badge.classList.toggle("badge-on", enabled);
      changesBadge.innerHTML = `
        <span class="status-dot"></span>
        <span>Changes applied</span>
      `;
      changesBadge.style.borderColor = "rgba(34,197,94,0.6)";
      changesBadge.style.color = "#bbf7d0";

      try {
        const res = await fetch(`/api/modules/toggle/${moduleId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...authHeader,
          },
          body: JSON.stringify({ guildId, enabled }),
        });
        const data = await res.json();
        if (!res.ok || (data.success !== true && data.enabled === undefined)) {
         throw new Error(data.error || "Toggle failed");
        }
        const idx = currentModules.findIndex((m) => m.id === moduleId);
        if (idx !== -1) currentModules[idx].enabled = enabled;
        showToast(
          `${currentModules[idx]?.name || moduleId} ${
            enabled ? "enabled" : "disabled"
          }`,
          "success"
        );
      } catch (err) {
        console.error("Toggle error:", err);
        // revert
        e.target.checked = !enabled;
        badge.textContent = !enabled ? "Enabled" : "Disabled";
        badge.classList.toggle("badge-on", !enabled);
        changesBadge.innerHTML = `
          <span class="status-dot" style="background:${"var(--error)"}; box-shadow:0 0 10px rgba(239,68,68,0.6);"></span>
          <span>Toggle failed</span>
        `;
        changesBadge.style.borderColor = "rgba(248,113,113,0.8)";
        changesBadge.style.color = "#fecaca";
        showToast("Failed to toggle module. Check API logs.", "error");
      }
    }

    // ====== MODAL LOGIC ======
    function openModuleModal(mod) {
      currentModule = mod;

      const def = MODULE_DEFINITIONS[mod.id] || { fields: [] };
      modalTitle.textContent = mod.name;
      modalSubtitle.textContent =
        def.subtitle || "Edit configuration for this module.";
      modalHints.textContent =
        def.hints ||
        "Values here are stored in MongoDB. Your bot should read them and sync them to its own models.";

      const settings = mod.settings || {};
      modalFields.innerHTML = "";

      const fields = def.fields || [];
      if (!fields.length) {
        const p = document.createElement("p");
        p.textContent =
          "This module currently has no specific editor. You can still toggle it on/off from the main view.";
        p.style.fontSize = "13px";
        p.style.color = "var(--text-muted)";
        modalFields.appendChild(p);
      } else {
        for (const field of fields) {
          const wrapper = document.createElement("div");
          wrapper.className = "field-group";

          const label = document.createElement("div");
          label.className = "field-label";
          label.textContent = field.label;

          const desc = document.createElement("div");
          desc.className = "field-description";
          desc.textContent = field.description || "";

          let input;
          if (field.type === "textarea") {
            input = document.createElement("textarea");
          } else {
            input = document.createElement("input");
            input.type = field.type || "text";
          }

          input.name = field.key;
          if (settings[field.key] !== undefined && settings[field.key] !== null) {
            input.value = String(settings[field.key]);
          }

          wrapper.appendChild(label);
          if (field.description) wrapper.appendChild(desc);
          wrapper.appendChild(input);
          modalFields.appendChild(wrapper);
        }
      }

      saveStatus.innerHTML =
        '<span class="icon">üíæ</span><span>Waiting for changes‚Ä¶</span>';
      modalBackdrop.classList.add("show");
    }

    function closeModuleModal() {
      modalBackdrop.classList.remove("show");
      currentModule = null;
    }

    async function saveModuleSettings() {
      if (!currentModule) return;

      const formData = new FormData(moduleForm);
      const settings = {};
      for (const [key, value] of formData.entries()) {
        settings[key] = value.trim();
      }

      saveStatus.innerHTML =
        '<span class="icon">‚è≥</span><span>Saving to MongoDB‚Ä¶</span>';
      changesBadge.innerHTML = `
        <span class="status-dot" style="background:${"var(--warning)"}; box-shadow:0 0 10px rgba(249,115,22,0.6);"></span>
        <span>Saving‚Ä¶</span>
      `;
      changesBadge.style.borderColor = "rgba(249,115,22,0.7)";
      changesBadge.style.color = "#fed7aa";

      try {
        const res = await fetch(`/api/modules/update/${currentModule.id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...authHeader,
          },
          body: JSON.stringify({ guildId, settings }),
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || "Save failed");
        }

        // update in-memory copy
        currentModule.settings = data.settings || settings;
        const idx = currentModules.findIndex(
          (m) => m.id === currentModule.id
        );
        if (idx !== -1) currentModules[idx] = currentModule;

        saveStatus.innerHTML =
          '<span class="icon">‚úÖ</span><span>Saved. Bot will pick up changes via Mongo.</span>';
        changesBadge.innerHTML = `
          <span class="status-dot"></span>
          <span>All changes saved</span>
        `;
        changesBadge.style.borderColor = "rgba(34,197,94,0.6)";
        changesBadge.style.color = "#bbf7d0";
        showToast("Module settings saved.", "success");
      } catch (err) {
        console.error("Save settings error:", err);
        saveStatus.innerHTML =
          '<span class="icon">‚ùå</span><span>Failed to save. Check API logs.</span>';
        changesBadge.innerHTML = `
          <span class="status-dot" style="background:${"var(--error)"}; box-shadow:0 0 10px rgba(239,68,68,0.6);"></span>
          <span>Save failed</span>
        `;
        changesBadge.style.borderColor = "rgba(248,113,113,0.8)";
        changesBadge.style.color = "#fecaca";
        showToast("Failed to save module settings.", "error");
      }
    }

    function resetModuleForm() {
      if (!currentModule) return;
      openModuleModal(currentModule);
      saveStatus.innerHTML =
        '<span class="icon">üíæ</span><span>Form reset to last saved values.</span>';
    }

    // ====== NAV + EVENTS ======
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "/dashboard.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("safeguard_token");
      localStorage.removeItem("sg_token");
      localStorage.removeItem("token");
      window.location.href = "/";
    });

    document
      .getElementById("closeModalBtn")
      .addEventListener("click", closeModuleModal);
    document
      .getElementById("saveFormBtn")
      .addEventListener("click", saveModuleSettings);
    document
      .getElementById("resetFormBtn")
      .addEventListener("click", resetModuleForm);

    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModuleModal();
    });

    // ====== INIT ======
    (async function init() {
      pageTitle.textContent = "Server Modules";
      await loadUser();
      await loadModules();
    })();
  </script>
</body>
</html>
