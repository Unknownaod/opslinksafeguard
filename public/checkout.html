<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Safeguard Premier Checkout – OpsLink Systems</title>
  <link rel="icon" href="/assets/Safeguard-Bot.png" />
  <script src="https://js.stripe.com/v3/"></script>

<style>
  :root {
    --bg: #04060d;
    --card: rgba(11, 18, 32, 0.85);
    --accent: #ff6600;
    --accent2: #ff944d;
    --text-main: #f5f7fa;
    --text-soft: #9da3af;
    --radius-lg: 18px;
    --shadow-accent: 0 0 25px rgba(255, 102, 0, 0.3);
    --transition: all 0.3s ease;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", sans-serif; }

  body {
    background: radial-gradient(circle at 25% 20%, #0b1220 0%, #05070f 80%);
    color: var(--text-main);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  nav {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 20px 60px;
    background: rgba(10, 15, 25, 0.6);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .nav-left { display: flex; align-items: center; gap: 12px; }
  .nav-left img { width: 40px; height: 40px; filter: drop-shadow(0 0 6px rgba(255,102,0,0.6)); }
  .nav-left span { font-size: 1.35rem; font-weight: 600; color: var(--accent); }

  .checkout-wrapper {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 60px 20px;
  }

  .checkout-container {
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: var(--radius-lg);
    padding: 45px;
    max-width: 620px;
    width: 100%;
    box-shadow: 0 0 35px rgba(255,102,0,0.1);
    backdrop-filter: blur(15px);
    animation: fadeIn 1s ease forwards;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  h1 {
    font-size: 1.8rem;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  p {
    text-align: center;
    color: var(--text-soft);
    margin-bottom: 35px;
    font-size: 0.95rem;
  }

  form { display: flex; flex-direction: column; gap: 20px; }

  label { font-size: 0.95rem; font-weight: 500; color: var(--text-main); }

  /* UNIVERSAL INPUT STYLING */
  input, select, .StripeElement {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: var(--radius-lg);
    padding: 15px;
    font-size: 1rem;
    width: 100%;
    color: var(--text-main);
    transition: var(--transition);
  }

  input:focus, select:focus, .StripeElement--focus {
    border-color: var(--accent);
    box-shadow: var(--shadow-accent);
    outline: none;
  }

  /* COUNTRY SELECT FIXED */
  select {
    appearance: none;
    cursor: pointer;
    background-image:
      linear-gradient(45deg, transparent 50%, var(--accent) 50%),
      linear-gradient(135deg, var(--accent) 50%, transparent 50%);
    background-position:
      calc(100% - 20px) calc(50%),
      calc(100% - 15px) calc(50%);
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
  }

  select option {
    background: #0b1220;
    color: white;
  }

  /* STRIPE FIELDS IMPROVED */
  .StripeElement {
    padding: 15px !important;
    border-radius: var(--radius-lg);
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    transition: var(--transition);
  }

  .StripeElement--focus {
    border-color: var(--accent) !important;
    box-shadow: 0 0 12px rgba(255,102,0,0.4) !important;
  }

  .StripeElement--invalid {
    border-color: #ff3333 !important;
  }

  /* CARD FIELD ROW FIX */
  .card-row {
    display: flex;
    gap: 12px;
  }

  .card-row > div {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .summary-box {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: var(--radius-lg);
    padding: 18px 20px;
    color: var(--text-soft);
    font-size: 0.9rem;
  }

  .summary-box strong { color: var(--text-main); }

  #submit-btn {
    padding: 15px;
    border: none;
    border-radius: var(--radius-lg);
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    color: white;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    box-shadow: 0 0 10px rgba(255,102,0,0.3);
  }

  #submit-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 20px rgba(255,102,0,0.6);
  }

  #payment-message {
    text-align: center;
    font-size: 0.95rem;
    color: var(--text-soft);
    min-height: 20px;
    margin-top: 5px;
  }

  .agreement-box {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 0.83rem;
    line-height: 1.4;
    color: var(--text-soft);
    background: rgba(255,255,255,0.03);
    border-radius: var(--radius-lg);
    padding: 12px;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .agreement-box input { width: 18px; height: 18px; cursor: pointer; }
  .agreement-box a { color: var(--accent2); text-decoration: none; }
  .agreement-box a:hover { text-decoration: underline; }

  footer {
    text-align: center;
    padding: 25px;
    font-size: 0.9rem;
    color: var(--text-soft);
    border-top: 1px solid rgba(255,255,255,0.05);
  }

  .glow {
    position: fixed;
    top: -200px;
    left: -200px;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255,102,0,0.25), transparent 70%);
    filter: blur(100px);
    z-index: 0;
    animation: float 12s ease-in-out infinite alternate;
  }

  @keyframes float {
    from { transform: translate(0,0) scale(1); }
    to { transform: translate(100px,80px) scale(1.2); }
  }
</style>

</head>
<body>

<div class="glow"></div>

<nav>
  <div class="nav-left">
    <img src="/assets/Safeguard-Bot.png" alt="Safeguard Logo" />
    <span>OpsLink Safeguard</span>
  </div>
</nav>

<div class="checkout-wrapper">
  <div class="checkout-container">
    <h1>Safeguard Premier Checkout</h1>
    <p>Securely complete your subscription. License activates instantly after payment.</p>

    <form id="payment-form">
      <label>Email Address</label>
      <input id="email" type="email" placeholder="Email Address (Required)" required />

      <label>Country</label>
      <select id="country">
        <option value="US" selected>United States</option>
        <option value="CA">Canada</option>
        <option value="GB">United Kingdom</option>
        <option value="AU">Australia</option>
        <option value="DE">Germany</option>
        <option value="FR">France</option>
        <option value="IN">India</option>
        <option value="Other">Other</option>
      </select>

      <label>Card Number</label>
      <div id="card-number" class="StripeElement"></div>

      <div class="card-row">
        <div>
          <label>Expiry</label>
          <div id="card-expiry" class="StripeElement"></div>
        </div>
        <div>
          <label>CVC</label>
          <div id="card-cvc" class="StripeElement"></div>
        </div>
      </div>

      <div class="summary-box" id="summary"></div>

      <label class="agreement-box">
        <input type="checkbox" id="agree">
        <span>
          I agree to recurring monthly billing of <strong>$7.99 USD</strong> (plus tax) until cancellation.
          Refunds unavailable once license is issued.
          I accept the
          <a href="https://legal.opslinksystems.xyz" target="_blank">Terms of Service</a> and
          <a href="https://legal.opslinksystems.xyz/billing.html" target="_blank">Billing Agreement</a>.
        </span>
      </label>

      <button id="submit-btn" type="submit">Start Subscription</button>
      <div id="payment-message"></div>
    </form>
  </div>
</div>

<footer>© 2025 OpsLink Systems Network — All Rights Reserved.</footer>

<script>
  const stripe = Stripe("pk_live_51SVFpBLQjsrxMZMFiPh041fNL37kau7u4uITjjmKXkBabyHvx30Xl6scvSFDHBJDZlG6C71GFKltPWMEQwcU8z1R00j99wuaPd");
  const elements = stripe.elements({ appearance: { theme: "night" } });

  const cardNumber = elements.create("cardNumber");
  const cardExpiry = elements.create("cardExpiry");
  const cardCvc = elements.create("cardCvc");

  cardNumber.mount("#card-number");
  cardExpiry.mount("#card-expiry");
  cardCvc.mount("#card-cvc");

  const taxRates = { US:0.08, CA:0.13, GB:0.20, AU:0.10, DE:0.19, FR:0.20, IN:0.18, Other:0.00 };
  const basePrice = 7.99;
  const countrySelect = document.getElementById("country");
  const summary = document.getElementById("summary");

  function updateTax() {
    const country = countrySelect.value;
    const tax = (basePrice * (taxRates[country] || 0)).toFixed(2);
    const total = (basePrice + parseFloat(tax)).toFixed(2);
    summary.innerHTML = `
      <div>Product: <strong>Safeguard Premier Subscription</strong></div>
      <div>Base Price: $${basePrice} USD</div>
      <div>Tax (${country}): $${tax}</div>
      <div><strong>Total: $${total} USD</strong></div>
    `;
  }

  updateTax();
  countrySelect.addEventListener("change", updateTax);

  document.getElementById("payment-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    const agree = document.getElementById("agree");
    const msg = document.getElementById("payment-message");
    const btn = document.getElementById("submit-btn");
    const country = countrySelect.value;

    if (!agree.checked) return msg.textContent = "❌ Please agree to billing terms.";
    if (!email) return msg.textContent = "❌ Email required.";

    msg.textContent = "Processing...";
    btn.disabled = true;

    try {
      const res = await fetch("/api/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, country })
      });

      const data = await res.json();
      const result = await stripe.confirmCardPayment(data.clientSecret, {
        payment_method: { card: cardNumber, billing_details: { email } }
      });

      if (result.error) {
        msg.textContent = "❌ " + result.error.message;
        btn.disabled = false;
      } else {
        msg.textContent = "✅ Subscription active! Redirecting...";
        setTimeout(() => window.location.href = `/success/${result.paymentIntent.id}`, 1200);
      }

    } catch (err) {
      msg.textContent = "❌ " + err.message;
      btn.disabled = false;
    }
  });
</script>

</body>
</html>
