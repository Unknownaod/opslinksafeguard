<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Safeguard Premier â€” Billing</title>
  <link rel="icon" href="/assets/Safeguard-Bot.png" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#050816; --panel:#0b1220ee; --accent:#ff6600; --accent-hover:#ff8c42;
      --text:#e5e7eb; --muted:#94a3b8; --radius:18px; --glass:rgba(255,255,255,.06);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body {
      background:linear-gradient(145deg,#050816,#090f2d);
      font-family:'Inter',sans-serif; color:var(--text);
      display:flex; justify-content:center; align-items:center;
      height:100vh; overflow:hidden;
    }
    .wrapper {
      width:480px; padding:48px; background:var(--panel);
      border-radius:var(--radius); text-align:center;
      border:1px solid var(--glass); backdrop-filter:blur(18px);
      box-shadow:0 0 40px rgba(0,0,0,.45); animation:fadeIn .6s ease-out;
    }
    h1 {
      font-size:2rem; margin-bottom:12px;
      background:linear-gradient(90deg,#ff6600,#ffa54d);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    p { font-size:1rem; color:var(--muted); margin-bottom:24px; }
    input {
      width:100%; padding:14px; background:#11172d; color:white;
      border:1px solid #1e2a44; border-radius:var(--radius);
      margin-bottom:16px; font-size:1rem; outline:none;
    }
    input:focus { border-color:var(--accent); box-shadow:0 0 6px #ff660040; }
    button {
      width:100%; padding:14px; margin-top:5px;
      font-size:1.05rem; font-weight:600;
      background:var(--accent); color:white; border:none;
      border-radius:var(--radius); cursor:pointer; transition:.25s;
      box-shadow:0 0 12px #ff660040;
    }
    button:hover { background:var(--accent-hover); transform:translateY(-2px); }
    .small-btn {
      background:#1a2238; margin-top:12px; box-shadow:none !important;
    }
    .small-btn:hover { background:#263355; }
    code { color:#ff8c42; font-size:1rem; }
    footer { font-size:.8rem; opacity:.5; margin-top:18px; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Billing & Subscription</h1>
    <p>Manage your Safeguard Premier billing profile and subscription.</p>

    <!-- DISPLAY SAVED CUSTOMER ID -->
    <div id="cidDisplay" style="display:none; margin-bottom:18px;">
      <small style="opacity:.7;">Your Stripe Customer ID:</small><br>
      <code id="cidText"></code>
      <button class="small-btn" onclick="resetCID()">Change Customer ID</button>
    </div>

    <!-- INPUT NEW CUSTOMER ID -->
    <div id="cidArea">
      <input id="cidInput" placeholder="Enter Stripe Customer ID (cus_xxxxxxx)">
      <button onclick="saveCID()">Save Customer ID</button>
    </div>

    <!-- OPEN BILLING PORTAL -->
    <button id="billingBtn" style="display:none;" onclick="openPortal()">
      Open Billing Portal
    </button>

    <footer>Powered securely by Stripe</footer>
  </div>

  <script>
    const cidDisplay = document.getElementById("cidDisplay");
    const cidArea = document.getElementById("cidArea");
    const cidText = document.getElementById("cidText");
    const billingBtn = document.getElementById("billingBtn");
    const cidInput = document.getElementById("cidInput");

    const savedCID = localStorage.getItem("safeguard_customer");
    if (savedCID) showCID(savedCID);

    function saveCID() {
      const val = cidInput.value.trim();
      if (!val.startsWith("cus_")) return alert("Customer ID must start with 'cus_'.");
      localStorage.setItem("safeguard_customer", val);
      showCID(val);
      alert("Customer ID saved successfully!");
    }

    function showCID(id) {
      cidText.innerText = id;
      cidArea.style.display = "none";
      cidDisplay.style.display = "block";
      billingBtn.style.display = "block";
    }

    function resetCID() {
      localStorage.removeItem("safeguard_customer");
      cidDisplay.style.display = "none";
      billingBtn.style.display = "none";
      cidArea.style.display = "block";
      cidInput.value = "";
    }

    async function openPortal() {
      const customerId = localStorage.getItem("safeguard_customer");
      if (!customerId) return alert("No billing profile found.");

      const res = await fetch("/api/billing/portal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ customerId })
      });

      const data = await res.json();
      if (data.url) window.location.href = data.url;
      else alert(data.message || "Unable to access billing portal.");
    }
  </script>
</body>
</html>
